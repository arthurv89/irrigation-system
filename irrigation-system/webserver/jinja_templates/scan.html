<script>

  function ajax_call() {
    var last_response_len = false;
    $.ajax('/api/scan',
      {
        type: "POST",
        dataType: "text",
        xhrFields: {
            onprogress: function(e)
            {
              var this_response, response = e.currentTarget.response;
              if(last_response_len === false) {
                  this_response = response;
                  last_response_len = response.length;
              }
              else {
                  this_response = response.substring(last_response_len);
                  last_response_len = response.length;
              }
              json = JSON.parse(this_response.trim().split('\n').slice(-1)[0])
              console.log("json", json)
              $(".scanning").html("<span class='scan-status-" + json['status'] + "'>" + json['message'] + "</span>");
            }
        }
    })
    .done(function(data) {
        $(".scan-now").show()
          .find("a").text("Scan again");
        addScanClickHandler();
    })
    .fail(function(data) {
        console.log('Error: ', data);
    });
  }

  var isScanning = false;
  function addScanClickHandler() {
    $("p.scan-now a").click(function() {
      if(isScanning) return;

      isScanning = true;
      $(".scan-now").hide();
      $(".scanning").html("Scanning...").show();
      ajax_call()
      isScanning = false;
      return false;
    });
  }

  $(document).ready(function() {
    addScanClickHandler();
  });

  // ajax_call();
  // setInterval(function(){ ajax_call(); }, 10000);
</script>
    <div class="box-header well">
        <h2>Scan sensors</h2>
    </div>
    <div class="box-content row">
        <div class="col-lg-7 col-md-12">
            <p class="scan-now"><a href="#">Scan now</a>
            <p class="scanning" style="display: none"></p>
        </div>
    </div>
