<script>
  const deviceId = "37961240619157332318";
  var valves = {}
  const opening_time = 60

  function disableButton(valvePosition) {
    valves[valvePosition]['disabled'] = true;
  }

  function enableButton(valvePosition) {
    valves[valvePosition]['disabled'] = false;
  }

  function toggleStatus(valvePosition) {
    valves[valvePosition]['status'] = !valves[valvePosition]['status']
  }

  function handleToggleValveClick(valvePosition) {
    toggleStatus(valvePosition)
    disableButton(valvePosition);
    renderButtons();
    $.ajax('/api/valve', {
        type: "POST",
        data: {
          "deviceId": deviceId,
          "valvePosition": valvePosition,
          "status": valves[valvePosition]['status'],
          "opening_time": opening_time
        }
    })
    .done(function(json) {
      enableButton(valvePosition)
      renderButtons();
    })
    .fail(function(data) {
        console.log('Error: ', data);
        toggleStatus(valvePosition)
        enableButton(valvePosition)
        renderButtons();
    });
    return false;
  }

  function addValveHandlers(valvePosition) {
    getButton(valvePosition).click(function() {
      handleToggleValveClick(valvePosition)
    });
  }

  function buttonId(valvePosition) {
    return `valve-${valvePosition}`;
  }

  function getButton(valvePosition) {
    return $(`#${buttonId(valvePosition)}`);
  }

  function createButton(valvePosition, timeRemaining, status, disabled) {
    const newStatus = status ? "off" : "on";
    const remainingStr = status ? `(${timeRemaining} sec)` : "";
    const button = $(`
      <button
          id="${buttonId(valvePosition)}"
          class="toggle-valve valve-${status} btn btn-primary"
          data-valve-id="${valvePosition}"
        >
        Turn ${newStatus} valve ${parseInt(valvePosition)+1} ${remainingStr}
      </button>`)
    button.prop('disabled', disabled);

    return button;
  }

  function renderButtons() {
    $('#button-container *').remove()

     var container = $('<div />');
     for (const valvePosition in valves) {
       const valve = valves[valvePosition]
       const status = valve['status'];
       const disabled = valve['disabled']
       const timeRemaining = valve['timeRemaining']

       const button = createButton(valvePosition, timeRemaining, status, disabled)
       container.append(button);
     }
     $('#button-container').html(container);

     Object.keys(valves).forEach((valvePosition, i) => {
       addValveHandlers(valvePosition);
     });
  }

  function get_valves() {
    $.ajax('/api/valve-status?deviceId=' + deviceId, {
        type: "GET",
    })
    .done(function(json) {
      for(i in json.response) {
        const obj = json.response[i]
        const valvePosition = obj['valve_position']
        valves[valvePosition] = {
            "status": obj['open'],
            "disabled": !obj['can_open'] || obj['open'],
            "timeRemaining": obj['time_remaining']
        }
      }
      console.log(valves)
      renderButtons();
    })
    .fail(function(data) {
        console.log('Error: ', data);
    });
  }

  $(document).ready(function() {
    setInterval( get_valves, 1000 )
  });
 </script>

<div class="box-header well">
    <h2>Controller actions</h2>
</div>
<div class="box-content row">
    <div class="col-lg-7 col-md-12">
      <div id="button-container"></div>
    </div>
</div>
