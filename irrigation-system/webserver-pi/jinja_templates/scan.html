<script>
  function ajax_call() {
    var last_response_len = false;
    $.ajax('/api/scan',
      {
        type: "POST",
        dataType: "text",
        xhrFields: {
            onprogress: function(e)
            {
              var this_response, response = e.currentTarget.response;
              if(last_response_len === false) {
                  this_response = response;
                  last_response_len = response.length;
              }
              else {
                  this_response = response.substring(last_response_len);
                  last_response_len = response.length;
              }
              json = JSON.parse(this_response.trim().split('\n').slice(-1)[0])
              console.log(json)
              const spans = json['messages'].map(message =>
                "<p class='scan-status-" + message['status'] + "'>" + message['message'] + "</p>")
              console.log("spans", spans)
              $(".output").html(spans);
            }
        }
    })
    .done(function(data) {
        $(".scan-now").prop('disabled', false)
          .text("Scan again");
    })
    .fail(function(data) {
        console.log('Error: ', data);
    });
  }

  var isScanning = false;
  function addScanClickHandler() {
    $(".scan-now").click(function() {
      if(isScanning) return;

      isScanning = true;
      $(".scan-now").prop('disabled', true)
        .text("Scanning...");
      $(".output").html("Scanning...").show();
      ajax_call()
      isScanning = false;
      return false;
    });
  }

  $(document).ready(function() {
    addScanClickHandler();
  });
</script>


<div class="box-header well">
    <h2>Scan sensors</h2>
</div>
<div class="box-content row">
    <div class="col-lg-7 col-md-12">
        <p><button class="scan-now btn btn-primary">Scan now</button></p>
        <p class="output" style="display: none"></p>
    </div>
</div>
